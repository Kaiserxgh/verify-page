<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Verification - TopNotch</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #FFE57F 0%, #FFA726 100%);
            color: #333;
            text-align: center;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 450px;
            width: 90%;
        }
        .icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        h1 {
            margin-bottom: 20px;
            font-size: 28px;
            font-weight: 600;
            color: #333;
        }
        p {
            font-size: 16px;
            margin-bottom: 20px;
            line-height: 1.6;
            color: #666;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .loading { color: #FF8C00; }
        .button {
            display: inline-block;
            text-decoration: none;
            color: #fff;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            padding: 14px 28px;
            border-radius: 25px;
            font-weight: 600;
            margin: 10px 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #FF8C00;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="message">
            <div class="icon loading">‚è≥</div>
            <h1 class="loading">Verifying Your Email</h1>
            <p>Please wait while we verify your email address...</p>
            <div class="spinner"></div>
        </div>
    </div>

    <script>
        console.log('üîÑ Email verification page loaded');
        console.log('üìç Current URL:', window.location.href);
        console.log('üîó Hash:', window.location.hash);
        console.log('üîç Search:', window.location.search);

        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const hash = window.location.hash.substring(1);
            const hashParams = new URLSearchParams(hash);
            const allParams = {};

            // Merge both search and hash parameters
            for (const [key, value] of params) {
                allParams[key] = value;
            }
            for (const [key, value] of hashParams) {
                allParams[key] = value;
            }
            
            return allParams;
        }

        function attemptDeepLink() {
            console.log('üì± Attempting to open TopNotch app...');
            
            // Get URL parameters
            const params = getUrlParams();
            console.log('üìã URL Parameters:', params);
            
            // Build deep link with ALL parameters
            let deepLink = 'mobile://auth/callback';
            const queryParams = new URLSearchParams();
            
            // Add all relevant parameters to the deep link
            if (params.access_token) {
                queryParams.append('access_token', params.access_token);
                console.log('‚úÖ Added access_token');
            }
            if (params.refresh_token) {
                queryParams.append('refresh_token', params.refresh_token);
                console.log('‚úÖ Added refresh_token');
            }
            if (params.type) {
                queryParams.append('type', params.type);
                console.log('‚úÖ Added type:', params.type);
            }
            if (params.token_hash) {
                queryParams.append('token_hash', params.token_hash);
                console.log('‚úÖ Added token_hash');
            }
            if (params.error) {
                queryParams.append('error', params.error);
                console.log('‚ö†Ô∏è Added error:', params.error);
            }
            if (params.error_description) {
                queryParams.append('error_description', params.error_description);
                console.log('‚ö†Ô∏è Added error_description');
            }
            if (params.error_code) {
                queryParams.append('error_code', params.error_code);
                console.log('‚ö†Ô∏è Added error_code');
            }
            
            // Build final deep link
            if (queryParams.toString()) {
                deepLink += '?' + queryParams.toString();
            }
            
            console.log('üîó Final deep link:', deepLink);
            
            // Try to open the app
            window.location.href = deepLink;
            
            // Fallback message if app doesn't open
            setTimeout(() => {
                const messageDiv = document.getElementById('message');
                messageDiv.innerHTML = `
                    <div class="icon">üì±</div>
                    <h1>Open TopNotch App</h1>
                    <p>If the app didn't open automatically, please open TopNotch manually.</p>
                    <p style="color: #4CAF50; font-weight: 600;">Your email has been verified!</p>
                    <button class="button" onclick="window.location.href='${deepLink}'">
                        Try Again
                    </button>
                    <button class="button" onclick="window.close()" style="background: linear-gradient(135deg, #FF8C00, #e67e00);">
                        Close This Page
                    </button>
                `;
            }, 3000);
        }

        function handleVerification() {
            const params = getUrlParams();
            console.log('üîç Processing verification with params:', params);

            const messageDiv = document.getElementById('message');
            const hasError = params.error || params.error_description;
            const hasTokens = params.access_token || params.refresh_token || params.token_hash;
            const isSignup = params.type === 'signup';

            // Handle errors
            if (hasError) {
                console.error('‚ùå Verification error:', params.error, params.error_description);
                
                let errorTitle = "Verification Failed";
                let errorMessage = `There was an error: ${params.error_description || params.error}`;
                let errorIcon = "‚ùå";
                
                // Check for specific error types
                if (params.error === 'access_denied' || params.error_code === 'otp_expired') {
                    errorTitle = "Link Already Used";
                    errorMessage = "This verification link has already been used or has expired. Your email may already be verified.";
                    errorIcon = "‚ÑπÔ∏è";
                } else if (params.error_description?.includes('expired')) {
                    errorTitle = "Link Expired";
                    errorMessage = "This verification link has expired. Verification links are only valid for 24 hours.";
                    errorIcon = "‚è∞";
                }

                messageDiv.innerHTML = `
                    <div class="icon error">${errorIcon}</div>
                    <h1 class="error">${errorTitle}</h1>
                    <p>${errorMessage}</p>
                    <p style="color: #4CAF50; margin-top: 20px;">
                        <strong>Good news:</strong> If you registered recently, your email is likely already verified! 
                        Try logging in to your TopNotch account.
                    </p>
                    <button class="button" onclick="attemptDeepLink()">Open TopNotch App</button>
                `;
                
                // Still try to open app after showing error
                setTimeout(attemptDeepLink, 2000);
                return;
            }

            // Success - has tokens or is signup type
            if (hasTokens || isSignup) {
                console.log('‚úÖ Verification successful');
                messageDiv.innerHTML = `
                    <div class="icon success">‚úÖ</div>
                    <h1 class="success">Email Verified Successfully!</h1>
                    <p>Welcome to TopNotch! Your email has been confirmed and your account is now active.</p>
                    <p style="color: #4CAF50; font-weight: 600;">Opening the app...</p>
                    <div class="spinner"></div>
                `;
                
                // Open app immediately
                setTimeout(attemptDeepLink, 1000);
            } else {
                // Already verified
                console.log('‚ÑπÔ∏è Email already verified');
                messageDiv.innerHTML = `
                    <div class="icon">‚ÑπÔ∏è</div>
                    <h1 style="color: #FF8C00;">Account Already Verified</h1>
                    <p>Your email address has already been verified!</p>
                    <p style="color: #4CAF50; font-weight: 600;">You can now log in to your TopNotch account.</p>
                    <button class="button" onclick="attemptDeepLink()">Open TopNotch App</button>
                `;
                
                setTimeout(attemptDeepLink, 2000);
            }
        }

        // Make attemptDeepLink available globally
        window.attemptDeepLink = attemptDeepLink;

        // Start verification when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ Page loaded, starting verification...');
            setTimeout(handleVerification, 1000);
        });

        // Fallback if DOMContentLoaded already fired
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            console.log('üìÑ Document already ready, starting verification immediately');
            setTimeout(handleVerification, 500);
        }

        // Try to close tab when app opens (visibility change)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('üëÅÔ∏è Page hidden - user likely switched to app');
                setTimeout(() => {
                    window.close();
                }, 1000);
            }
        });
    </script>
</body>
</html>
